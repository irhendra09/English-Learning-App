// Vocabulary data
        const vocabulary = [
								{
									"word": "Wake up",
									"meaning": "Bangun tidur",
									"sentence": "I wake up at 6 AM every day.",
									"theme": "Daily Activities"
								},
								{
									"word": "Brush",
									"meaning": "Menggosok",
									"sentence": "I brush my teeth after breakfast.",
									"theme": "Daily Activities"
								},
								{
									"word": "Shower",
									"meaning": "Mandi",
									"sentence": "She takes a shower in the morning.",
									"theme": "Daily Activities"
								},
								{
									"word": "Eat",
									"meaning": "Makan",
									"sentence": "We eat lunch at 1 PM.",
									"theme": "Daily Activities"
								},
								{
									"word": "Drink",
									"meaning": "Minum",
									"sentence": "I drink water when I\u2019m thirsty.",
									"theme": "Daily Activities"
								},
								{
									"word": "Sleep",
									"meaning": "Tidur",
									"sentence": "He sleeps at 10 PM.",
									"theme": "Daily Activities"
								},
								{
									"word": "Study",
									"meaning": "Belajar",
									"sentence": "I study English every night.",
									"theme": "Daily Activities"
								},
								{
									"word": "Work",
									"meaning": "Bekerja",
									"sentence": "My dad works at a bank.",
									"theme": "Daily Activities"
								},
								{
									"word": "Cook",
									"meaning": "Memasak",
									"sentence": "My mom cooks delicious food.",
									"theme": "Daily Activities"
								},
								{
									"word": "Clean",
									"meaning": "Membersihkan",
									"sentence": "I clean my room on Sunday.",
									"theme": "Daily Activities"
								},
								{
									"word": "Read",
									"meaning": "Membaca",
									"sentence": "She reads a book before bed.",
									"theme": "Daily Activities"
								},
								{
									"word": "Write",
									"meaning": "Menulis",
									"sentence": "I write in my journal.",
									"theme": "Daily Activities"
								},
								{
									"word": "Listen",
									"meaning": "Mendengarkan",
									"sentence": "They listen to music.",
									"theme": "Daily Activities"
								},
								{
									"word": "Watch",
									"meaning": "Menonton",
									"sentence": "We watch movies on weekends.",
									"theme": "Daily Activities"
								},
								{
									"word": "Play",
									"meaning": "Bermain",
									"sentence": "The kids play in the park.",
									"theme": "Daily Activities"
								},
								{
									"word": "Happy",
									"meaning": "Bahagia",
									"sentence": "I feel happy today.",
									"theme": "Emotions"
								},
								{
									"word": "Sad",
									"meaning": "Sedih",
									"sentence": "She looks sad.",
									"theme": "Emotions"
								},
								{
									"word": "Angry",
									"meaning": "Marah",
									"sentence": "He is angry because of the noise.",
									"theme": "Emotions"
								},
								{
									"word": "Excited",
									"meaning": "Bersemangat",
									"sentence": "We are excited for the trip!",
									"theme": "Emotions"
								},
								{
									"word": "Nervous",
									"meaning": "Gugup",
									"sentence": "I'm nervous before the test.",
									"theme": "Emotions"
								},
								{
									"word": "Bored",
									"meaning": "Bosan",
									"sentence": "I get bored during long meetings.",
									"theme": "Emotions"
								},
								{
									"word": "Tired",
									"meaning": "Lelah",
									"sentence": "She\u2019s tired after running.",
									"theme": "Emotions"
								},
								{
									"word": "Scared",
									"meaning": "Takut",
									"sentence": "The kid is scared of the dark.",
									"theme": "Emotions"
								},
								{
									"word": "Surprised",
									"meaning": "Terkejut",
									"sentence": "I was surprised by the gift.",
									"theme": "Emotions"
								},
								{
									"word": "Calm",
									"meaning": "Tenang",
									"sentence": "Stay calm during emergencies.",
									"theme": "Emotions"
								},
								{
									"word": "Confused",
									"meaning": "Bingung",
									"sentence": "He\u2019s confused about the homework.",
									"theme": "Emotions"
								},
								{
									"word": "Proud",
									"meaning": "Bangga",
									"sentence": "I\u2019m proud of you!",
									"theme": "Emotions"
								},
								{
									"word": "Shy",
									"meaning": "Pemalu",
									"sentence": "She is shy in public.",
									"theme": "Emotions"
								},
								{
									"word": "Jealous",
									"meaning": "Iri/cemburu",
									"sentence": "He\u2019s jealous of his brother.",
									"theme": "Emotions"
								},
								{
									"word": "Grateful",
									"meaning": "Bersyukur",
									"sentence": "I\u2019m grateful for my family.",
									"theme": "Emotions"
								},
								{
									"word": "Chair",
									"meaning": "Kursi",
									"sentence": "I sit on the chair.",
									"theme": "Home"
								},
								{
									"word": "Table",
									"meaning": "Meja",
									"sentence": "The books are on the table.",
									"theme": "Home"
								},
								{
									"word": "Bed",
									"meaning": "Tempat tidur",
									"sentence": "I sleep on a soft bed.",
									"theme": "Home"
								},
								{
									"word": "Window",
									"meaning": "Jendela",
									"sentence": "Please open the window.",
									"theme": "Home"
								},
								{
									"word": "Door",
									"meaning": "Pintu",
									"sentence": "Close the door, please.",
									"theme": "Home"
								},
								{
									"word": "Lamp",
									"meaning": "Lampu",
									"sentence": "Turn on the lamp, it\u2019s dark.",
									"theme": "Home"
								},
								{
									"word": "Mirror",
									"meaning": "Cermin",
									"sentence": "She looks in the mirror.",
									"theme": "Home"
								},
								{
									"word": "Sofa",
									"meaning": "Sofa",
									"sentence": "We relax on the sofa.",
									"theme": "Home"
								},
								{
									"word": "Clock",
									"meaning": "Jam dinding",
									"sentence": "The clock shows 9 o'clock.",
									"theme": "Home"
								},
								{
									"word": "Carpet",
									"meaning": "Karpet",
									"sentence": "The carpet is dirty.",
									"theme": "Home"
								},
								{
									"word": "TV",
									"meaning": "Televisi",
									"sentence": "They watch TV together.",
									"theme": "Home"
								},
								{
									"word": "Fan",
									"meaning": "Kipas angin",
									"sentence": "The fan keeps the room cool.",
									"theme": "Home"
								},
								{
									"word": "Fridge",
									"meaning": "Kulkas",
									"sentence": "Milk is in the fridge.",
									"theme": "Home"
								},
								{
									"word": "Shelf",
									"meaning": "Rak",
									"sentence": "I put my books on the shelf.",
									"theme": "Home"
								},
								{
									"word": "Curtain",
									"meaning": "Tirai/gorden",
									"sentence": "She opened the curtain to let light in.",
									"theme": "Home"
								},
								{
									"word": "Bread",
									"meaning": "Roti",
									"sentence": "I eat bread for breakfast.",
									"theme": "Food"
								},
								{
									"word": "Rice",
									"meaning": "Nasi",
									"sentence": "We always eat rice at lunch.",
									"theme": "Food"
								},
								{
									"word": "Chicken",
									"meaning": "Ayam",
									"sentence": "She cooks spicy chicken.",
									"theme": "Food"
								},
								{
									"word": "Fish",
									"meaning": "Ikan",
									"sentence": "He doesn\u2019t like fish.",
									"theme": "Food"
								},
								{
									"word": "Egg",
									"meaning": "Telur",
									"sentence": "I boiled two eggs.",
									"theme": "Food"
								},
								{
									"word": "Soup",
									"meaning": "Sup",
									"sentence": "This soup is hot and tasty.",
									"theme": "Food"
								},
								{
									"word": "Noodles",
									"meaning": "Mie",
									"sentence": "I love eating noodles!",
									"theme": "Food"
								},
								{
									"word": "Apple",
									"meaning": "Apel",
									"sentence": "She eats an apple a day.",
									"theme": "Food"
								},
								{
									"word": "Banana",
									"meaning": "Pisang",
									"sentence": "Bananas are yellow.",
									"theme": "Food"
								},
								{
									"word": "Water",
									"meaning": "Air",
									"sentence": "Drink more water every day.",
									"theme": "Food"
								},
								{
									"word": "Juice",
									"meaning": "Jus",
									"sentence": "Orange juice is my favorite.",
									"theme": "Food"
								},
								{
									"word": "Milk",
									"meaning": "Susu",
									"sentence": "Kids should drink milk.",
									"theme": "Food"
								},
								{
									"word": "Tea",
									"meaning": "Teh",
									"sentence": "Let\u2019s have a cup of tea.",
									"theme": "Food"
								},
								{
									"word": "Coffee",
									"meaning": "Kopi",
									"sentence": "He drinks coffee in the morning.",
									"theme": "Food"
								},
								{
									"word": "Snack",
									"meaning": "Camilan",
									"sentence": "I bring snacks to school.",
									"theme": "Food"
								}
							];

        let currentWordIndex = 0;
        let favoriteWords = JSON.parse(localStorage.getItem('favoriteWords')) || [];
        let inQuizMode = false;
        let currentQuizWord = null;
        let currentQuizType = 'meaning'; // 'meaning' or 'sentence'

        // Variables for Sentence Reordering Quiz
        let originalSentenceWords = []; // The correct words from the sentence, cleaned
        let scrambledWordButtons = []; // Array of { word: string, buttonElement: HTMLElement, originalIndex: number }
        let builtSentenceWords = []; // Words currently in the sentence builder

        // Web Speech Recognition variables
        let recognition;
        let isRecognizing = false;

        // Get DOM elements
        const wordElement = document.getElementById('word');
        const meaningElement = document.getElementById('meaning');
        const sentenceElement = document.getElementById('sentence');
        const wordThemeElement = document.getElementById('wordTheme');
        const pronounceWordButton = document.getElementById('pronounceWordButton');
        const pronounceSentenceButton = document.getElementById('pronounceSentenceButton');
        const speechRateInput = document.getElementById('speechRate');
        const currentRateDisplay = document.getElementById('currentRate');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const shuffleButton = document.getElementById('shuffleButton');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const favoriteButton = document.getElementById('favoriteButton');
        const toggleQuizButton = document.getElementById('toggleQuizButton');
        const quizSection = document.getElementById('quizSection');
        const quizQuestionElement = document.getElementById('quizQuestion');
        const meaningQuizOptions = document.getElementById('meaningQuizOptions');
        const quizFeedbackElement = document.getElementById('quizFeedback');
        const nextQuizButton = document.getElementById('nextQuizButton');
        const exitQuizButton = document.getElementById('exitQuizButton');

        // New DOM elements for Sentence Reordering Quiz
        const sentenceQuizContainer = document.getElementById('sentenceQuizContainer');
        const scrambledWordsContainer = document.getElementById('scrambledWordsContainer');
        const sentenceBuilderContainer = document.getElementById('sentenceBuilderContainer');
        const checkSentenceButton = document.getElementById('checkSentenceButton');
        const resetSentenceButton = document.getElementById('resetSentenceButton');

        // New DOM elements for Speech Practice
        const startSpeechButton = document.getElementById('startSpeechButton');
        const stopSpeechButton = document.getElementById('stopSpeechButton');
        const speechRecognizedText = document.getElementById('speechRecognizedText');
        const speechFeedback = document.getElementById('speechFeedback');

        /**
         * Initializes the Web Speech Recognition API.
         */
        function initializeSpeechRecognition() {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'en-US'; // Set recognition language to English
                recognition.interimResults = false; // Only return final results
                recognition.maxAlternatives = 1; // Get only the most probable result

                recognition.onstart = () => {
                    isRecognizing = true;
                    startSpeechButton.disabled = true;
                    stopSpeechButton.disabled = false;
                    speechRecognizedText.textContent = "Listening...";
                    speechFeedback.textContent = "";
                    speechFeedback.classList.remove('correct', 'incorrect');
                    speechFeedback.classList.add('listening');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    speechRecognizedText.textContent = `You said: "${transcript}"`;
                    checkPronunciation(transcript);
                };

                recognition.onend = () => {
                    isRecognizing = false;
                    startSpeechButton.disabled = false;
                    stopSpeechButton.disabled = true;
                    if (speechRecognizedText.textContent === "Listening...") {
                        speechRecognizedText.textContent = "Say the word or sentence..."; // Reset if nothing was said
                    }
                    speechFeedback.classList.remove('listening');
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    speechFeedback.textContent = `Error: ${event.error}`;
                    speechFeedback.classList.add('incorrect');
                    isRecognizing = false;
                    startSpeechButton.disabled = false;
                    stopSpeechButton.disabled = true;
                    speechRecognizedText.textContent = "Say the word or sentence...";
                };
            } else {
                startSpeechButton.disabled = true;
                stopSpeechButton.disabled = true;
                speechRecognizedText.textContent = "Speech Recognition not supported in this browser.";
                alert("Your browser does not support Web Speech Recognition. Please try Chrome or Edge.");
            }
        }

        /**
         * Starts the speech recognition process.
         */
        function startSpeechPractice() {
            if (recognition && !isRecognizing) {
                recognition.start();
            }
        }

        /**
         * Stops the speech recognition process.
         */
        function stopSpeechPractice() {
            if (recognition && isRecognizing) {
                recognition.stop();
            }
        }

        /**
         * Checks the recognized speech against the current word or sentence.
         * @param {string} recognizedText - The text transcribed by speech recognition.
         */
        function checkPronunciation(recognizedText) {
            const currentWordData = vocabulary[currentWordIndex];
            const targetWord = currentWordData.word.toLowerCase();
            const targetSentence = currentWordData.sentence.toLowerCase().replace(/[.,!?;:"]/g, ''); // Clean sentence

            const cleanRecognizedText = recognizedText.toLowerCase().trim().replace(/[.,!?;:"]/g, '');

            // Check against word first, then sentence
            if (cleanRecognizedText === targetWord) {
                speechFeedback.textContent = "Great! You pronounced the word correctly! 🎉";
                speechFeedback.classList.add('correct');
                speechFeedback.classList.remove('incorrect');
            } else if (cleanRecognizedText === targetSentence) {
                speechFeedback.textContent = "Excellent! You pronounced the sentence correctly! 🎉";
                speechFeedback.classList.add('correct');
                speechFeedback.classList.remove('incorrect');
            } else {
                speechFeedback.textContent = `Try again. You said: "${recognizedText}". Target: "${currentWordData.word}" or "${currentWordData.sentence}".`;
                speechFeedback.classList.add('incorrect');
                speechFeedback.classList.remove('correct');
            }
        }


        /**
         * Displays the word at the currentWordIndex in the UI.
         */
        function displayWord() {
            if (vocabulary.length === 0) {
                wordElement.textContent = "No words available.";
                meaningElement.textContent = "";
                sentenceElement.textContent = "";
                wordThemeElement.textContent = "";
                pronounceWordButton.disabled = true;
                pronounceSentenceButton.disabled = true;
                speechRateInput.disabled = true;
                favoriteButton.disabled = true;
                startSpeechButton.disabled = true; // Disable speech practice buttons
                stopSpeechButton.disabled = true;
                speechRecognizedText.textContent = "Say the word or sentence...";
                speechFeedback.textContent = "";
                speechFeedback.classList.remove('correct', 'incorrect', 'listening');
                return;
            }

            const wordData = vocabulary[currentWordIndex];
            wordElement.textContent = wordData.word;
            meaningElement.textContent = wordData.meaning;
            sentenceElement.textContent = wordData.sentence;
            wordThemeElement.textContent = `Theme: ${wordData.theme}`;
            pronounceWordButton.disabled = false;
            pronounceSentenceButton.disabled = false;
            speechRateInput.disabled = false;
            favoriteButton.disabled = false;
            startSpeechButton.disabled = false; // Enable speech practice buttons
            stopSpeechButton.disabled = true; // Stop button starts disabled
            speechRecognizedText.textContent = "Say the word or sentence..."; // Reset text
            speechFeedback.textContent = ""; // Clear feedback
            speechFeedback.classList.remove('correct', 'incorrect', 'listening');
            updateFavoriteButton();
        }

        /**
         * Updates the favorite button's appearance based on whether the current word is favorited.
         */
        function updateFavoriteButton() {
            const currentWord = vocabulary[currentWordIndex].word;
            if (favoriteWords.includes(currentWord)) {
                favoriteButton.classList.add('favorited');
                favoriteButton.innerHTML = '<span class="star-icon">★</span> Favorited';
            } else {
                favoriteButton.classList.remove('favorited');
                favoriteButton.innerHTML = '<span class="star-icon">☆</span> Favorite';
            }
        }

        /**
         * Toggles the favorite status of the current word and updates localStorage.
         */
        function toggleFavorite() {
            const currentWord = vocabulary[currentWordIndex].word;
            const index = favoriteWords.indexOf(currentWord);
            if (index > -1) {
                // Word is already favorited, remove it
                favoriteWords.splice(index, 1);
            } else {
                // Word is not favorited, add it
                favoriteWords.push(currentWord);
            }
            localStorage.setItem('favoriteWords', JSON.stringify(favoriteWords));
            updateFavoriteButton();
        }

        /**
         * Pronounces the given text using the Web Speech API.
         * @param {string} textToSpeak - The text to be pronounced.
         */
        function speakText(textToSpeak) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'en-US'; // Set language to English
                utterance.rate = parseFloat(speechRateInput.value); // Set speech rate
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn("Speech Synthesis API not supported in this browser.");
                alert("Your browser does not support text-to-speech. Please try a different browser.");
            }
        }

        /**
         * Pronounces the current word.
         */
        function pronounceWord() {
            speakText(vocabulary[currentWordIndex].word);
        }

        /**
         * Pronounces the current sentence.
         */
        function pronounceSentence() {
            speakText(vocabulary[currentWordIndex].sentence);
        }

        /**
         * Updates the displayed speech rate value.
         */
        function updateRateDisplay() {
            currentRateDisplay.textContent = `${speechRateInput.value}x`;
        }

        /**
         * Moves to the next word in the vocabulary list.
         */
        function nextWord() {
            currentWordIndex = (currentWordIndex + 1) % vocabulary.length;
            displayWord();
        }

        /**
         * Moves to the previous word in the vocabulary list.
         */
        function prevWord() {
            currentWordIndex = (currentWordIndex - 1 + vocabulary.length) % vocabulary.length;
            displayWord();
        }

        /**
         * Displays a random word from the vocabulary list.
         */
        function shuffleWord() {
            currentWordIndex = Math.floor(Math.random() * vocabulary.length);
            displayWord();
        }

        /**
         * Searches for a word and displays it if found.
         * If multiple matches, it displays the first one.
         */
        function searchWord() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (searchTerm === "") {
                displayWord();
                return;
            }

            const foundIndex = vocabulary.findIndex(wordObj =>
                wordObj.word.toLowerCase().includes(searchTerm) ||
                wordObj.meaning.toLowerCase().includes(searchTerm)
            );

            if (foundIndex !== -1) {
                currentWordIndex = foundIndex;
                displayWord();
                searchInput.value = '';
            } else {
                alert(`Word "${searchTerm}" not found.`);
            }
        }

        /**
         * Starts or exits the quiz mode.
         */
        function toggleQuizMode() {
            inQuizMode = !inQuizMode;
            if (inQuizMode) {
                quizSection.classList.add('active');
                document.querySelector('.word-display').style.display = 'none';
                document.querySelector('.control-buttons').style.display = 'none';
                document.querySelector('.search-container').style.display = 'none';
                toggleQuizButton.textContent = 'Exit Quiz';
                generateQuizQuestion();
            } else {
                quizSection.classList.remove('active');
                document.querySelector('.word-display').style.display = 'flex';
                document.querySelector('.control-buttons').style.display = 'flex';
                document.querySelector('.search-container').style.display = 'flex';
                toggleQuizButton.textContent = 'Start Quiz';
                quizFeedbackElement.textContent = '';
                nextQuizButton.style.display = 'none';
                displayWord();
            }
        }

        /**
         * Generates a new quiz question based on currentQuizType.
         */
        function generateQuizQuestion() {
            quizFeedbackElement.textContent = '';
            nextQuizButton.style.display = 'none';

            // Randomly choose between meaning quiz and sentence reordering quiz
            currentQuizType = Math.random() < 0.5 ? 'meaning' : 'sentence';

            if (currentQuizType === 'meaning') {
                meaningQuizOptions.classList.add('active');
                sentenceQuizContainer.classList.remove('active');
                generateMeaningQuiz();
            } else {
                // Ensure there's a sentence to quiz on
                const wordsWithSentences = vocabulary.filter(word => word.sentence && word.sentence.length > 0);
                if (wordsWithSentences.length === 0) {
                    alert("No words with sample sentences available for sentence reordering quiz.");
                    toggleQuizMode(); // Exit quiz if no sentences
                    return;
                }
                meaningQuizOptions.classList.remove('active');
                sentenceQuizContainer.classList.add('active');
                generateSentenceReorderingQuiz();
            }
        }

        /**
         * Generates a meaning/word quiz question.
         */
        function generateMeaningQuiz() {
            // Select a random word for the quiz
            const correctWordIndex = Math.floor(Math.random() * vocabulary.length);
            currentQuizWord = vocabulary[correctWordIndex];

            // Determine if we're asking for the word from the meaning or vice versa
            const questionType = Math.random() < 0.5 ? 'meaningToWord' : 'wordToMeaning';

            let questionText = '';
            let correctAnswer = '';
            if (questionType === 'meaningToWord') {
                questionText = `What is the English word for "${currentQuizWord.meaning}"?`;
                correctAnswer = currentQuizWord.word;
            } else {
                questionText = `What is the meaning of "${currentQuizWord.word}"?`;
                correctAnswer = currentQuizWord.meaning;
            }
            quizQuestionElement.textContent = questionText;

            // Generate options
            const options = [correctAnswer];
            while (options.length < 4) {
                const randomOtherWordIndex = Math.floor(Math.random() * vocabulary.length);
                const randomOtherWord = vocabulary[randomOtherWordIndex];
                let potentialOption = questionType === 'meaningToWord' ? randomOtherWord.word : randomOtherWord.meaning;

                if (!options.includes(potentialOption) && potentialOption !== correctAnswer) {
                    options.push(potentialOption);
                }
            }

            // Shuffle options
            options.sort(() => Math.random() - 0.5);

            meaningQuizOptions.innerHTML = ''; // Clear previous options
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('btn-secondary');
                button.onclick = () => checkMeaningAnswer(option, correctAnswer);
                meaningQuizOptions.appendChild(button);
            });
        }

        /**
         * Checks the user's meaning/word quiz answer.
         * @param {string} selectedOption - The option selected by the user.
         * @param {string} correctAnswer - The correct answer for the question.
         */
        function checkMeaningAnswer(selectedOption, correctAnswer) {
            // Disable all option buttons after selection
            Array.from(meaningQuizOptions.children).forEach(button => {
                button.disabled = true;
                if (button.textContent === correctAnswer) {
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-success'); // Highlight correct answer
                } else if (button.textContent === selectedOption) {
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-danger'); // Highlight incorrect selection
                }
            });

            if (selectedOption === correctAnswer) {
                quizFeedbackElement.textContent = "Correct! 🎉";
                quizFeedbackElement.style.color = '#48bb78'; // Green
            } else {
                quizFeedbackElement.textContent = `Incorrect. The correct answer was "${correctAnswer}".`;
                quizFeedbackElement.style.color = '#ef4444'; // Red
            }
            nextQuizButton.style.display = 'block'; // Show next question button
        }

        /**
         * Generates a sentence reordering quiz question.
         */
        function generateSentenceReorderingQuiz() {
            quizQuestionElement.textContent = "Arrange the words to form the correct sentence:";
            quizFeedbackElement.textContent = '';
            nextQuizButton.style.display = 'none';

            // Select a random word that has a sentence
            const wordsWithSentences = vocabulary.filter(word => word.sentence && word.sentence.length > 0);
            const correctWordIndex = Math.floor(Math.random() * wordsWithSentences.length);
            currentQuizWord = wordsWithSentences[correctWordIndex];

            // Clean and split the sentence into words
            const sentence = currentQuizWord.sentence;
            // Remove punctuation and split by spaces, filter out empty strings
            originalSentenceWords = sentence.replace(/[.,!?;:"]/g, '').split(/\s+/).filter(word => word.length > 0);

            // Create scrambled words for display
            const scrambledWords = [...originalSentenceWords]; // Copy the array
            // Shuffle the copied array
            for (let i = scrambledWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [scrambledWords[i], scrambledWords[j]] = [scrambledWords[j], scrambledWords[i]];
            }

            // Initialize built sentence and scrambled word buttons
            builtSentenceWords = [];
            scrambledWordButtons = scrambledWords.map((word, index) => {
                const button = document.createElement('button');
                button.textContent = word;
                button.classList.add('scrambled-word-button');
                button.dataset.originalIndex = index; // Store original index for re-enabling
                button.onclick = (event) => addWordToSentence(event.target);
                return { word: word, element: button, originalIndex: index };
            });

            renderSentenceQuizUI();
        }

        /**
         * Renders the UI for the sentence reordering quiz.
         */
        function renderSentenceQuizUI() {
            scrambledWordsContainer.innerHTML = '';
            sentenceBuilderContainer.innerHTML = '';

            // Render scrambled words
            scrambledWordButtons.forEach(btnObj => {
                scrambledWordsContainer.appendChild(btnObj.element);
            });

            // Render built sentence
            builtSentenceWords.forEach((word, index) => {
                const span = document.createElement('span');
                span.textContent = word;
                span.classList.add('built-word');
                // Store the index in builtSentenceWords for removal
                span.dataset.builtIndex = index;
                span.onclick = (event) => removeWordFromSentence(event.target);
                sentenceBuilderContainer.appendChild(span);
                if (index < builtSentenceWords.length - 1) {
                    sentenceBuilderContainer.appendChild(document.createTextNode(' ')); // Add space between words
                }
            });
        }

        /**
         * Adds a word to the sentence builder when a scrambled word button is clicked.
         * @param {HTMLElement} clickedButton - The button element that was clicked.
         */
        function addWordToSentence(clickedButton) {
            builtSentenceWords.push(clickedButton.textContent);
            clickedButton.disabled = true; // Disable the button after it's used
            clickedButton.classList.remove('scrambled-word-button');
            clickedButton.classList.add('btn-secondary'); // Change style to indicate it's used
            renderSentenceQuizUI();
        }

        /**
         * Removes a word from the sentence builder when a built word is clicked.
         * @param {HTMLElement} clickedSpan - The span element representing the word in the builder.
         */
        function removeWordFromSentence(clickedSpan) {
            const indexToRemove = parseInt(clickedSpan.dataset.builtIndex);
            const wordToRemove = builtSentenceWords[indexToRemove];

            // Remove from builtSentenceWords
            builtSentenceWords.splice(indexToRemove, 1);

            // Re-enable the corresponding scrambled word button
            const correspondingButton = scrambledWordButtons.find(btnObj =>
                btnObj.element.textContent === wordToRemove && btnObj.element.disabled
            );

            if (correspondingButton) {
                correspondingButton.element.disabled = false;
                correspondingButton.element.classList.remove('btn-secondary');
                correspondingButton.element.classList.add('scrambled-word-button');
            }
            renderSentenceQuizUI();
        }


        /**
         * Checks if the built sentence matches the original sentence.
         */
        function checkSentence() {
            const builtSentence = builtSentenceWords.join(' ').toLowerCase();
            const correctSentence = originalSentenceWords.join(' ').toLowerCase();

            if (builtSentence === correctSentence) {
                quizFeedbackElement.textContent = "Correct! �";
                quizFeedbackElement.style.color = '#48bb78'; // Green
            } else {
                quizFeedbackElement.textContent = `Incorrect. The correct sentence was: "${currentQuizWord.sentence}".`;
                quizFeedbackElement.style.color = '#ef4444'; // Red
            }
            nextQuizButton.style.display = 'block'; // Show next question button
            // Disable all scrambled word buttons after checking
            scrambledWordButtons.forEach(btnObj => btnObj.element.disabled = true);
            // Disable built words from being removed
            Array.from(sentenceBuilderContainer.children).forEach(span => span.onclick = null);
        }

        /**
         * Resets the sentence reordering quiz.
         */
        function resetSentenceQuiz() {
            builtSentenceWords = [];
            scrambledWordButtons.forEach(btnObj => {
                btnObj.element.disabled = false;
                btnObj.element.classList.remove('btn-secondary');
                btnObj.element.classList.add('scrambled-word-button');
            });
            quizFeedbackElement.textContent = '';
            nextQuizButton.style.display = 'none';
            renderSentenceQuizUI();
        }


        // Event Listeners
        pronounceWordButton.addEventListener('click', pronounceWord);
        pronounceSentenceButton.addEventListener('click', pronounceSentence);
        speechRateInput.addEventListener('input', updateRateDisplay);
        nextButton.addEventListener('click', nextWord);
        prevButton.addEventListener('click', prevWord);
        shuffleButton.addEventListener('click', shuffleWord);
        searchButton.addEventListener('click', searchWord);
        favoriteButton.addEventListener('click', toggleFavorite);
        toggleQuizButton.addEventListener('click', toggleQuizMode);
        nextQuizButton.addEventListener('click', generateQuizQuestion);
        exitQuizButton.addEventListener('click', toggleQuizMode);

        // New Event Listeners for Sentence Reordering Quiz
        checkSentenceButton.addEventListener('click', checkSentence);
        resetSentenceButton.addEventListener('click', resetSentenceQuiz);

        // New Event Listeners for Speech Practice
        startSpeechButton.addEventListener('click', startSpeechPractice);
        stopSpeechButton.addEventListener('click', stopSpeechPractice);


        // Initial display and initialization when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeSpeechRecognition(); // Initialize speech recognition on load
            displayWord();
            updateRateDisplay();
        });